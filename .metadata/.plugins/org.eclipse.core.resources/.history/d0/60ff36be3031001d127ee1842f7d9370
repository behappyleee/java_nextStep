package webserver;

import java.io.File;
import java.io.IOException;
import java.io.OutputStream;
import java.nio.file.Files;
import java.util.HashMap;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class HttpResponse {
	
	Logger logger = LoggerFactory.getLogger(this.getClass());
	
	private static final String defaultPath = "./webapp";
	
	// 응답 데이터를 처리하는 로직을 별도의 클래스로 분리 
	// 응답 헤더 정보를 Map<String, String> 으로 관리 (RequestHandler 코드 중복을 줄이기 위함)
	// HTML/CSS/JavaScript 파일을 직접 읽어 응답으로 보내는 메서드는 forward() 다른 URL 로 리다이렉트 메서드는 sendRedirect() 로 관리
	
	HashMap<String, Object> responseHeaderInfo = new HashMap<>();
	
	OutputStream fileOutput;
	
	public HttpResponse(OutputStream fileOutputStream) {
		logger.debug("HTTP RESPONSE FILE OUTPUT STREAM : {} ", fileOutputStream);
		this.fileOutput = fileOutputStream;
	}
	
	// forward 메서드는 HTML / CS / JavaScript 파일을 직접 읽어 응답으로 보내는 메서드
	public void forward(String path) throws IOException {
		String[] splitDot = path.split("[.]");
		String fileExtension = splitDot[splitDot.length-1];
		
		logger.debug("FILE EXTENSION INFO DATA : {} " , fileExtension);
		
		byte[] readFile = Files.readAllBytes(new File(defaultPath + path).toPath());
		
		if(fileExtension.equals("html")) { 
			success200HeaderHTMLData(readFile);
		} else if(fileExtension.equals("css")) {
			
		}
		responseBody(readFile);
	}
	
	// 다른 URL로 리다이렉트 하는 메서드 
	public void sendRedirect() {
		
		
	}
	
	// 성공 200 HTML Header 출력 !
	public void success200HeaderHTMLData(byte[] contentData) throws IOException {
		StringBuilder headerData = new StringBuilder();
		headerData.append("HTTP/1.1 200 OK \r\n");
		headerData.append("Content-Type: text/html; \r\n");
		headerData.append("Content-Length: " + contentData.length + "\r\n");
		headerData.append("\r\n");
		fileOutput.write(headerData.toString().getBytes());
	}
	
	// 성공 200 CSS Header 출력 !
	public void success200HeaderCSSData(byte[] contentData) throws IOException {
		StringBuilder headerData = new StringBuilder();
		headerData.append("HTTP/1.1 200 OK \r\n");
		headerData.append("Content-Type: text/css; \r\n");
		headerData.append("Content-Length: " + contentData.length + "\r\n");
		headerData.append("\r\n");
		fileOutput.write(headerData.toString().getBytes());
	}
	
	// 파일 읽은 결과를 Body 에 출력 시켜줌 
	public void responseBody(byte[] bodyData) {
		try {
			fileOutput.write(bodyData);
		} catch(IOException e) {
			e.printStackTrace();
		}
	}

	
// 		REQUEST / RESPONSE 	
//		POST /user/create HTTP/1.1
//		Host: localhost:8080
//		Connection: keep-alive
//		Content-Length: 46
//		Content-Type: application/x-www-form-urlencoded
//		Accept: */*
//
//		userId=javajigi&password=password&name=JaeSung
//		
	
	
	
}
